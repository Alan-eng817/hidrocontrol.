<!DOCTYPE html>
<html lang="pt-BR" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HidroControl Pro - Alumar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        window.FB_CORE = { initializeApp, getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; transition: all 0.3s ease; }
        .glass-dark { background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(16px); }
        .glass-light { background: rgba(255, 255, 255, 0.85); border: 1px solid rgba(0, 0, 0, 0.05); backdrop-filter: blur(16px); }
        .animate-pop { animation: fadeIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="overflow-x-hidden hide-scroll">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // ‚úÖ CONFIGURA√á√ÉO FIREBASE ALUMAR (MANTIDA)
        const CONFIG_MANUAL_FIREBASE = {
            apiKey: "AIzaSyAPM1NNw9PazMccz5kxZjFAqOYKLqQwLxo", 
            authDomain: "hidrocontrol-alumar.firebaseapp.com",
            projectId: "hidrocontrol-alumar",
            storageBucket: "hidrocontrol-alumar.firebasestorage.app",
            messagingSenderId: "1080945827345",
            appId: "1:1080945827345:web:bd083793e95f943cb25bb0"
        };

        const ADMIN_EMAIL = "alanlindoso1@gmail.com";

        const EQUIPAMENTOS_LISTA = [
            "025A-TC-21A", "025A-TC-21B", "025A-TC-21C", "025A-TC-21D", "025A-TC-21E", "025A-TC-21F",
            "025A-TC-31A", "025A-TC-31B", "025A-TC-31C", "025A-TC-31D", "025A-TC-31E", "025A-TC-31F",
            "030-TC-001", "030-TC-002", "030-TC-003", "030-TC-004", "030-TC-005", "030-TC-006", "030-TC-007", "030-TC-008", "030-TC-009", "030-TC-010",
            "030-TC-011", "030-TC-011A", "030-TC-011B", "030-TC-11A", "030-TC-11B", "030-TC-11C", "030-TC-11D", "030-TC-11E", "030-TC-11F",
            "030-TC-12A", "030-TC-12B", "030-TC-12C", "030-TC-12D", "030-TC-12E", "030-TC-12F",
            "030-TC-13A", "030-TC-13B", "030-TC-13C", "030-TC-13D", "030-TC-13E", "030-TC-13F",
            "030-TC-21A", "030-TC-21B", "030-TC-21C", "030-TC-21D", "030-TC-22A", "030-TC-22B", "030-TC-22C", "030-TC-22D",
            "030-TC-23A", "030-TC-23B", "030-TC-23C", "030-TC-23D", "030-TC-24A", "030-TC-24B", "030-TC-24C", "030-TC-24D",
            "030-VA-16", "030-VA-17", "030-VA-18",
            "035-TC-011", "035-TC-012", "035-TC-013", "035K-TC-011", "035K-TC-012",
            "040-TC-011", "040-TC-012", "040-TC-013", "040-TC-014", "040-TC-015",
            "040-TC-021", "040-TC-022", "040-TC-023", "040-TC-024", "040-TC-025",
            "042-TC-011", "042-TC-012", "042-TC-013", "042-TC-014", "042-TC-015",
            "042-TC-021", "042-TC-022", "042-TC-023", "042-TC-024", "042-TC-025",
            "042-TC-031", "042-TC-032", "042-TC-033", "042-TC-034", "042-TC-035", "042-TC-039"
        ];

        // Componentes de √çcones
        const IconLancar = () => <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const IconDash = () => <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconCamera = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
        const IconWhatsApp = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12.031 6.172c-2.203 0-3.991 1.789-3.991 3.991 0 .86.273 1.656.74 2.308l-.513 1.874 1.921-.504a3.978 3.978 0 0 0 1.843.456c2.203 0 3.991-1.789 3.991-3.991 0-2.203-1.788-3.991-3.991-3.991zm2.348 5.617c-.1.282-.578.536-.795.568-.217.032-.435.056-1.258-.266-.822-.323-1.354-1.157-1.394-1.212-.04-.054-.33-.44-.33-.84s.21-.6.284-.68c.074-.08.162-.1.216-.1.054 0 .108 0 .156.006.054.004.12.004.186.162.066.162.228.552.246.594.018.042.03.09.006.138-.024.048-.042.084-.126.18-.084.096-.15.162-.222.246-.078.078-.156.168-.066.324.09.156.39.642.84 1.044.576.516 1.062.678 1.212.75.15.072.24.06.33-.042.09-.102.39-.456.492-.612.102-.156.204-.132.342-.084.138.048.876.414 1.026.492.15.078.252.114.288.18.036.066.036.384-.066.666z"/></svg>;

        const App = () => {
            const [user, setUser] = useState(null);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [view, setView] = useState('form'); 
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [darkMode, setDarkMode] = useState(true);
            const [turno, setTurno] = useState('ADM');
            
            const [items, setItems] = useState([{ tag: '', limpos: '', obs: '', ferro: '', search: '', showList: false }]);

            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                const init = async () => {
                    while (!window.FB_CORE) await new Promise(r => setTimeout(r, 100));
                    const app = window.FB_CORE.initializeApp(CONFIG_MANUAL_FIREBASE);
                    const a = window.FB_CORE.getAuth(app);
                    const d = window.FB_CORE.getFirestore(app);
                    setAuth(a); setDb(d);
                    window.FB_CORE.onAuthStateChanged(a, (u) => setUser(u));
                };
                init();
            }, []);

            useEffect(() => {
                if (!db || !user) return;
                const unsub = window.FB_CORE.onSnapshot(window.FB_CORE.collection(db, 'artifacts', 'hidrocontrol', 'public', 'data', 'registos'), (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.ts - a.ts);
                    setHistory(data);
                });
                return () => unsub();
            }, [db, user]);

            // Gr√°fico do Dashboard
            useEffect(() => {
                if (view === 'dash' && chartRef.current && history.length > 0) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    
                    const totalLimpos = history.reduce((acc, r) => acc + r.items.reduce((a,i) => a + Number(i.limpos || 0), 0), 0);
                    const totalObs = history.reduce((acc, r) => acc + r.items.reduce((a,i) => a + Number(i.obs || 0), 0), 0);
                    const totalFerro = history.reduce((acc, r) => acc + r.items.reduce((a,i) => a + Number(i.ferro || 0), 0), 0);

                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Limpos', 'Obstru√≠dos', 'Ferro'],
                            datasets: [{
                                data: [totalLimpos, totalObs, totalFerro],
                                backgroundColor: ['#22c55e', '#eab308', '#ef4444'],
                                borderWeight: 0,
                                cutout: '75%'
                            }]
                        },
                        options: { 
                            plugins: { legend: { display: false } },
                            animation: { duration: 2000, easing: 'easeOutQuart' }
                        }
                    });
                }
            }, [view, history]);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                const email = e.target.email.value;
                const pass = e.target.pass.value;
                try {
                    await window.FB_CORE.signInWithEmailAndPassword(auth, email, pass);
                } catch {
                    try {
                        await window.FB_CORE.createUserWithEmailAndPassword(auth, email, pass);
                    } catch (err) { alert("Erro: " + err.code); }
                } finally { setLoading(false); }
            };

            const handleAddItem = () => setItems([...items, { tag: '', limpos: '', obs: '', ferro: '', search: '', showList: false }]);
            
            const handleRemoveItem = (idx) => setItems(items.filter((_, i) => i !== idx));

            const updateItem = (idx, field, val) => {
                const newItems = [...items];
                newItems[idx][field] = val;
                setItems(newItems);
            };

            const handleSend = async () => {
                if (!db || items.some(i => !i.tag)) return;
                setLoading(true);
                try {
                    const docData = {
                        data: new Date().toLocaleDateString('pt-BR'),
                        turno,
                        items: items.map(i => ({ tag: i.tag, limpos: i.limpos, obs: i.obs, ferro: i.ferro })),
                        user: user.email,
                        ts: Date.now()
                    };
                    await window.FB_CORE.addDoc(window.FB_CORE.collection(db, 'artifacts', 'hidrocontrol', 'public', 'data', 'registos'), docData);
                    
                    // WhatsApp Link
                    const text = `*HIDROCONTROL - MONTISOL*%0Aüìå *Turno:* ${turno}%0A` + 
                        items.map(i => `üõ†Ô∏è *TAG:* ${i.tag}%0A‚úÖ Limpos: ${i.limpos || 0}%0A‚ö†Ô∏è Ferro: ${i.ferro || 0}`).join('%0A---%0A');
                    window.open(`https://wa.me/?text=${text}`, '_blank');

                    setItems([{ tag: '', limpos: '', obs: '', ferro: '', search: '', showList: false }]);
                    setView('dash');
                } catch (e) { alert("Erro ao gravar."); }
                setLoading(false);
            };

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-slate-950">
                    <div className="glass-dark w-full max-w-sm p-10 rounded-[3.5rem] shadow-2xl text-center space-y-8 animate-pop">
                        <h1 className="font-black text-3xl uppercase italic tracking-tighter text-white">HIDRO<span className="text-blue-500">CONTROL</span></h1>
                        <form onSubmit={handleLogin} className="space-y-4 text-left">
                            <input name="email" type="email" placeholder="E-mail" className="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 text-white outline-none font-bold" required />
                            <input name="pass" type="password" placeholder="Senha" className="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 text-white outline-none font-bold" required />
                            <button type="submit" className="w-full bg-blue-600 py-5 rounded-2xl font-black uppercase text-xs text-white shadow-xl active:scale-95 transition-all">Entrar</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className={`min-h-screen flex flex-col max-w-lg mx-auto ${darkMode ? 'bg-slate-950 text-white' : 'bg-slate-50 text-slate-900'}`}>
                    <header className="p-6 flex justify-between items-center sticky top-0 z-50 backdrop-blur-lg border-b border-white/5">
                        <div className="flex flex-col">
                            <h1 className="font-black text-xl italic uppercase tracking-tighter leading-none">Hidro<span className="text-blue-500">Control</span></h1>
                            <span className="text-[8px] font-bold opacity-30 uppercase tracking-[0.2em] mt-1">Alumar Monitor</span>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={() => setDarkMode(!darkMode)} className={`w-10 h-10 rounded-full flex items-center justify-center border transition-all ${darkMode ? 'border-white/10 bg-white/5' : 'border-black/5 bg-black/5'}`}>
                                {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                            </button>
                            <button onClick={() => window.FB_CORE.signOut(auth)} className="bg-red-500/10 text-red-500 text-[9px] font-black uppercase px-4 py-2 rounded-xl border border-red-500/20 active:scale-90 transition-all">Sair</button>
                        </div>
                    </header>

                    <main className="p-6 pb-44">
                        {view === 'form' ? (
                            <div className="space-y-6 animate-pop">
                                {/* Turno */}
                                <div className="grid grid-cols-3 gap-2">
                                    {['ADM', 'T.C', 'T.A'].map(t => (
                                        <button key={t} onClick={() => setTurno(t)} className={`py-4 rounded-2xl font-black text-xs transition-all border ${turno === t ? 'bg-blue-600 border-blue-400 text-white shadow-lg' : 'bg-slate-900/50 border-white/5 text-slate-500'}`}>{t}</button>
                                    ))}
                                </div>

                                {/* Itens do Relat√≥rio */}
                                {items.map((it, idx) => (
                                    <section key={idx} className={`${darkMode ? 'glass-dark' : 'glass-light'} p-8 rounded-[3rem] space-y-6 relative shadow-xl border-l-[10px] border-blue-600`}>
                                        <button onClick={() => handleRemoveItem(idx)} className="absolute top-6 right-6 text-red-500/50 hover:text-red-500 transition-all">
                                            <IconTrash />
                                        </button>

                                        <div className="space-y-2 relative">
                                            <label className="text-[10px] font-black uppercase opacity-50 tracking-widest ml-2">Equipamento (TAG)</label>
                                            <input 
                                                type="text" 
                                                placeholder="PESQUISAR OU DIGITAR..." 
                                                value={it.search}
                                                onFocus={() => updateItem(idx, 'showList', true)}
                                                onChange={(e) => {
                                                    updateItem(idx, 'search', e.target.value.toUpperCase());
                                                    updateItem(idx, 'tag', e.target.value.toUpperCase());
                                                }}
                                                className={`w-full p-5 rounded-2xl border outline-none font-black text-sm tracking-wider ${darkMode ? 'bg-slate-900 border-slate-800 text-blue-400' : 'bg-white border-slate-200 text-blue-600'}`} 
                                            />
                                            {it.showList && it.search.length > 0 && (
                                                <div className="absolute z-50 left-0 right-0 mt-2 bg-slate-900 rounded-2xl shadow-2xl max-h-48 overflow-y-auto border border-white/10">
                                                    {EQUIPAMENTOS_LISTA.filter(tag => tag.includes(it.search)).map(tag => (
                                                        <div key={tag} onClick={() => { updateItem(idx, 'tag', tag); updateItem(idx, 'search', tag); updateItem(idx, 'showList', false); }} className="px-6 py-4 hover:bg-blue-600 border-b border-white/5 text-xs font-bold text-white cursor-pointer">{tag}</div>
                                                    ))}
                                                    <div onClick={() => updateItem(idx, 'showList', false)} className="px-6 py-4 text-xs font-bold text-blue-400 cursor-pointer">Usar como novo: {it.search}</div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="grid grid-cols-3 gap-3">
                                            <div className="space-y-2 text-center">
                                                <label className="text-[9px] font-black uppercase text-green-500">Limpos</label>
                                                <input type="number" value={it.limpos} onChange={e => updateItem(idx, 'limpos', e.target.value)} className={`w-full p-4 rounded-2xl border text-center font-black text-lg ${darkMode ? 'bg-slate-900 border-green-500/10' : 'bg-white border-green-500/10'}`} placeholder="0" />
                                            </div>
                                            <div className="space-y-2 text-center text-yellow-500">
                                                <label className="text-[9px] font-black uppercase">Obs.</label>
                                                <input type="number" value={it.obs} onChange={e => updateItem(idx, 'obs', e.target.value)} className={`w-full p-4 rounded-2xl border text-center font-black text-lg ${darkMode ? 'bg-slate-900 border-yellow-500/10' : 'bg-white border-yellow-500/10'}`} placeholder="0" />
                                            </div>
                                            <div className="space-y-2 text-center text-red-500">
                                                <label className="text-[9px] font-black uppercase">Ferro</label>
                                                <input type="number" value={it.ferro} onChange={e => updateItem(idx, 'ferro', e.target.value)} className={`w-full p-4 rounded-2xl border text-center font-black text-lg ${darkMode ? 'bg-slate-900 border-red-500/10' : 'bg-white border-red-500/10'}`} placeholder="0" />
                                            </div>
                                        </div>
                                        
                                        {/* Simula√ß√£o Fotos */}
                                        <div className="grid grid-cols-2 gap-2 pt-2">
                                            <button className="flex items-center justify-center gap-2 p-4 rounded-2xl border-2 border-dashed border-white/5 opacity-30 text-[9px] font-black uppercase"><IconCamera /> Antes</button>
                                            <button className="flex items-center justify-center gap-2 p-4 rounded-2xl border-2 border-dashed border-white/5 opacity-30 text-[9px] font-black uppercase"><IconCamera /> Depois</button>
                                        </div>
                                    </section>
                                ))}

                                <button onClick={handleAddItem} className="w-full py-4 border-2 border-dashed border-white/10 rounded-3xl text-slate-500 font-black text-[10px] uppercase hover:border-blue-500 transition-all">+ Adicionar TAG</button>
                                
                                <button onClick={handleSend} disabled={loading} className="w-full bg-blue-600 py-6 rounded-[2.5rem] font-black uppercase text-sm shadow-[0_20px_50px_rgba(37,99,235,0.3)] active:scale-95 transition-all flex items-center justify-center gap-3">
                                    {loading ? 'Processando...' : <><IconWhatsApp /> Enviar e Sincronizar</>}
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-6 animate-pop">
                                <div className={`${darkMode ? 'glass-dark' : 'glass-light'} p-8 rounded-[3.5rem] shadow-2xl relative overflow-hidden flex items-center justify-between`}>
                                    <div className="z-10">
                                        <h2 className="text-5xl font-black tracking-tighter leading-none">
                                            {history.reduce((acc, r) => acc + r.items.reduce((a,i) => a + Number(i.limpos || 0), 0), 0)}
                                        </h2>
                                        <p className="text-[10px] font-black opacity-30 uppercase tracking-[0.2em] mt-2">Tubos Limpos</p>
                                    </div>
                                    <div className="w-28 h-28 relative flex items-center justify-center">
                                        <canvas ref={chartRef} className="z-10"></canvas>
                                        <div className="absolute inset-0 flex items-center justify-center">
                                            <div className="w-16 h-16 rounded-full border-4 border-white/5"></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <label className="text-[10px] font-black uppercase opacity-30 ml-4 tracking-widest">Atividade Recente</label>
                                    {history.slice(0, 10).map(h => (
                                        <div key={h.id} className={`${darkMode ? 'glass-dark' : 'glass-light'} p-5 rounded-[2rem] flex justify-between items-center border border-white/5`}>
                                            <div className="space-y-1">
                                                <p className="text-sm font-black tracking-tight leading-none">{h.items[0]?.tag} {h.items.length > 1 && <span className="text-[10px] text-blue-500 ml-1">+{h.items.length-1}</span>}</p>
                                                <p className="text-[9px] font-bold opacity-40 uppercase">{h.data} ‚Ä¢ {h.turno}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-lg font-black text-green-500 leading-none">+{h.items.reduce((a,i) => a + Number(i.limpos || 0), 0)}</p>
                                                <p className="text-[8px] font-bold opacity-20 uppercase">Registados</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className={`fixed bottom-0 left-0 right-0 ${darkMode ? 'glass-dark' : 'glass-light'} border-t border-white/10 p-10 flex justify-around items-center rounded-t-[4rem] z-50 shadow-[0_-20px_60px_rgba(0,0,0,0.6)]`}>
                        <button onClick={() => setView('form')} className={`flex flex-col items-center gap-2 transition-all ${view === 'form' ? 'text-blue-500 scale-125' : 'opacity-20'}`}>
                            <IconLancar /><span className="text-[9px] font-black uppercase tracking-tighter">Lan√ßar</span>
                        </button>
                        <div className="w-[1px] h-8 bg-white/5"></div>
                        <button onClick={() => setView('dash')} className={`flex flex-col items-center gap-2 transition-all ${view === 'dash' ? 'text-blue-500 scale-125' : 'opacity-20'}`}>
                            <IconDash /><span className="text-[9px] font-black uppercase tracking-tighter">Painel</span>
                        </button>
                    </nav>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
